<!-- daniel create at 2018-05-22.-->
<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<!DOCTYPE html>
<html>
<head>
<title>Index收盘</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script type="text/javascript"
	src="/deri-web/plug-in/jquery/jquery-1.8.3.js"></script>
<link media="screen" rel="stylesheet"
	href="/deri-web/plug-in/finanstar/css/htmlDatePicker.css" />
<script type="text/javascript"
	src="/deri-web/plug-in/finanstar/js/htmlDatePicker.js"></script>
<link media="screen" rel="stylesheet"
	href="/deri-web/plug-in/finanstar/css/body.css" />
<style type="text/css">
h1 {
	margin: 0 auto;
}

.outer {
	width: 800px;
	margin-top: 20px;
	margin-left: 20px;
	border: 1 solid red;
}

#view {
	width: 350px;
	margin-top: 20px;
	margin-left: 20px;
	border: 1 solid red;
}

.title {
	font-size: 1.5em;
	font-family: 'microsoft yahei';
}

li {
	color: green;
	font-size: 1.5em;
}

.but {
	width: 500px;
}

button {
	width: 120px;
	height: 30px;
	background: orange;
	margin-left: 30px;
}

button:hover {
	background: green;
	color: yellow;
}

table {
	border-top-color: black;
	border-right-color: black;
	border-bottom-color: black;
	border-left-color: black;
	border-top-style: solid;
	border-right-style: solid;
	border-bottom-style: solid;
	border-left-style: solid;
	width: 300px;
	border-top-width: 0px;
	border-right-width: 0px;
	border-bottom-width: 1px;
	border-left-width: 1px;
}

td {
	text-align: center;
	border-color: black;
	border-style: solid solid none none;
	border-width: 1px;
	font-size: 0.95em;
	text-align: left;
	padding-left: 20px;
}

.math {
	width: 26px;
	height: 26px;
	background: orange;
}

.tableborder {
	border-top-width: 1px;
	border-right-width: 1px;
	border-bottom-width: 1px;
	border-left-width: 1px;
	/*以上分别设置的是表格边框中上右下左的边框宽度*/
	border-top-style: solid;
	border-right-style: solid;
	border-bottom-style: solid;
	border-left-style: solid;
	/*设置边框的表现样式，solid为实线*/
	border-top-color: black;
	border-right-color: black;
	border-bottom-color: black;
	border-left-color: black;
	/*设置边框的颜色*/
}
</style>
</head>

<body>

	<div style="margin-top: 30px; width: 800px;">
		<div style="margin-left: 250px;">
			<div class="title" style="font-size: 1.5em;">Index收盘</div>
		</div>
		<div class="outer">
			<div align="left" class="l">
				<font style="color: blue; width: 80px; text-align: right;">
					计价日 &nbsp; </font>
				<input type="button" class="math" disabled="disabled" value="-"
					onclick="dealDate('-')">
				&nbsp;
				<!-- onClick="GetDate(this)" -->
				<input type='text' name='ValueDate' id='ValueDate' value=''
					readonly="readonly"
					style='width: 100px; height: 25px; background: lightgray; text-align: center; font-size: 0.95em;' />
				&nbsp;
				<input type="button" class="math" disabled="disabled" value="+"
					onclick="dealDate('+')">
			</div>
		</div>
		<div class="outer">
			<div align="left" class="l">
				<font style="color: blue; width: 80px; text-align: right;">类型
					&nbsp; </font>
				<select id='Type' name='Type'
					style='width: 500px; height: 27px; font-size: 0.95em;'>
					<option value='fx'>FX</option>
					<option value='cash'>CASH</option>
					<option value='swap'>SWAP</option>
				</select>
				<br> <br> <font
					style="color: blue; width: 80px; text-align: right;">市场
					&nbsp; </font>
				<select id='Book' name='Book'
					style='width: 500px; height: 27px; font-size: 0.95em;'>
					<option value='all'>ALL</option>
					<option value='usdcny'>USDCNY</option>
					<option value='eurusd'>EURUSD</option>
					<option value='gbpusd'>GBPUSD</option>
					<option value='usdjpy'>USDJPY</option>
					<option value='usdchf'>USDCHF</option>
					<option value='audusd'>AUDUSD</option>
					<option value='usdcad'>USDCAD</option>
				</select>
			</div>
		</div>
		<div class="outer">
			<div align="left" class="but">
				<div class="batchbottom" align="left">
					<button type="button" id="Read" style="font-size: 100%;">读取</button>
					<button type="button" id="Save"
						style="font-size: 100%; display: none;">保存</button>
					&nbsp;&nbsp;&nbsp;<span id="tips"></span>
				</div>
			</div>
		</div>
		<!-- <div align="center" style="height: 30px; width: 300px;">
			
		</div> -->
		<div id="view"></div>
	</div>
	<ul id="info" style="margin-top: 30px; margin-left: 40px;"></ul>
</body>
<script type="text/javascript">
    childwindow = []
    var TypeMarketsJson = {
	'fx' : "all,usdcny,eurusd,gbpusd,usdjpy,usdchf,audusd,usdcad",
	'cash' : "all,eurib,usdlb,gbplb,jpylb,chflb",
	'swap' : "all,eurib,usdlb"
    }
    var data;
    function makeOption(arr) {
	html = ""
	$.each(arr, function(i, v) {
	    html += "<option value='"+v+"'>" + v.toUpperCase() + "</option>"
	})
	return html
    }
    $(function() {

	$("#Type").change(
		function() {
		    $("#view").empty()
		    $("#Save").hide();
		    $("#tips").html("")
		    $("#Book").html(
			    makeOption(TypeMarketsJson[$(this).val()]
				    .split(",")))
		})

	$("#ValueDate").val(getTime())

	$("#batA").show()

	$("#Read")
		.click(
			function() {
			    console.log($(this).html() + ":"
				    + $("#ValueDate").val().replace(/\-/g, "")
				    + ":" + $("#Book").val());
			    var info = $(this).html() + ":"
				    + $("#ValueDate").val().replace(/\-/g, "")
				    + ":" + $("#Type").val() + ":"
				    + $("#Book").val();

			    if ($("#Type").val() == 'fx') {

				//api.finanstar.cn/market
				$.getJSON(
					"http://localhost:8082/spider/index/fx/"
						+ $("#Book").val()
						+ "?jsoncallback=?", function(
						json) {
					    console.log(json);
					});

				try {
				    /* $
				    .ajax({
				        type : "GET", // 提交的方法
				        url : "https://api.finanstar.cn/market/spider/index/fx/"
				    	    + $("#Book").val(), // 提交的地址
				        useDefaultXhrHeader : false,
				        async : false,
				        error : function(request) { // 失败的话
				        },
				        success : function(j) {// 成功
				    	alert(j)
				    	if (j.code == '0') {
				    	    data = j.data
				    	    console.log(data)
				    	    $
				    		    .each(
				    			    data,
				    			    function(k,
				    				    v) {

				    				//market

				    				var market = k
				    					.toUpperCase()
				    				var dataCsv = v
				    				var dataArr = v
				    					.split(",")

				    				html = "<br><span>"
				    					+ market
				    					+ "</span><br>"
				    					+ "<table border='1' align='center' cellpadding='0' cellspacing='0'>"
				    				html += makeTr(
				    					"Tenor",
				    					"Date,Index",
				    					'head')
				    				for (var i = 0; i < dataArr.length; i++) {
				    				    var ti = dataArr[i]
				    					    .split(" ")
				    				    html += makeTr(
				    					    ti[0],
				    					    ti[1]
				    						    + ","
				    						    + ti[2])
				    				}
				    				html += "</table>"
				    				$(html)
				    					.appendTo(
				    						$("#view"))
				    				$(
				    					"#tips")
				    					.html(
				    						"<font color='green'>Done Read.</font>")
				    				$(
				    					"#Save")
				    					.show();
				    			    })

				    	} else {
				    	    $("#tips")
				    		    .html(
				    			    "<br><font color='red'>"
				    				    + j.obj
				    				    + "</font>")
				    	}

				        },
				        dataType : "json"
				    }); */

				} catch (e) {
				    console.log(e)
				}
			    } else {
				$
					.ajax({
					    type : "POST", // 提交的方法
					    url : "/deri-web/marketDataController.do?doIndexDataCrawler", // 提交的地址
					    data : "&info=" + info,
					    async : false,
					    error : function(request) { // 失败的话
					    },
					    success : function(j) {// 成功
						if (j.msg == 'ok') {
						    data = j.obj
						    console.log(j.obj)
						    $
							    .each(
								    data,
								    function(k,
									    v) {

									//market

									var market = k
										.toUpperCase()
									var dataCsv = v
									var dataArr = v
										.split(",")

									html = "<br><span>"
										+ market
										+ "</span><br>"
										+ "<table border='1' align='center' cellpadding='0' cellspacing='0'>"
									html += makeTr(
										"Tenor",
										"Date,Index",
										'head')
									for (var i = 0; i < dataArr.length; i++) {
									    var ti = dataArr[i]
										    .split(" ")
									    html += makeTr(
										    ti[0],
										    ti[1]
											    + ","
											    + ti[2])
									}
									html += "</table>"
									$(html)
										.appendTo(
											$("#view"))
									$(
										"#tips")
										.html(
											"<font color='green'>Done Read.</font>")
									$(
										"#Save")
										.show();
								    })

						} else {
						    $("#tips")
							    .html(
								    "<br><font color='red'>"
									    + j.obj
									    + "</font>")
						}

					    },
					    dataType : "json"
					});

			    }
			});

	$("#Save")
		.click(
			function() {

			    console.log(data.toString())

			    $
				    .ajax({
					type : "POST", // 提交的方法
					url : "/deri-web/marketDataController.do?doIndexDataCrawlerSave&type="
						+ $("#Type").val(), // 提交的地址
					data : "&data="
						+ JSON.stringify(data)
						+ "&date="
						+ $("#ValueDate").val()
							.replace(/\-/g, ""),
					async : false,
					error : function(request) { // 失败的话
					},
					success : function(j) {// 成功
					    $("#tips").html(
						    "<br><br><font color='green'>"
							    + j.obj
							    + " Saved.</font>")
					    // setTimeout("$(\"#tips\").html('')", 3500);
					},
					dataType : "json"
				    });
			});

	$("#Save").mousedown(function() {
	    $("#tips").html("<font color='green'>Saving</font>")
	});
	$("#Read").mousedown(function() {
	    $("#view").empty()
	    $("#Save").hide();
	    $("#tips").html("<font color='green'>Reading</font>")
	});

    });

    function dealDate(option) {

	var oldYMD = $("#ValueDate").val();

	var ymdArr = oldYMD.split("-");

	var date = new Date(parseInt(ymdArr[0]), parseInt(ymdArr[1]) - 1,
		parseInt(ymdArr[2]));

	switch (option) {
	case "+":
	    date.setDate(date.getDate() + 1)
	    break;
	case "-":
	    date.setDate(date.getDate() - 1)
	    break;
	default:
	    break;
	}

	$("#ValueDate").val(formatTime(date));

    }

    function creatediv() {
	return $("<div></div>")
    }

    function makeTr(k, v) {
	var td = "<td style='background: lightcyan; font-size: 1em;'>" + k
		+ "</td>"
	v = v.split(",")
	for (var i = 0; i < v.length; i++) {
	    td += "<td>" + v[i] + "</td>"
	}
	if (arguments[2] == 'head')
	    return "<tr height='35px' style='background: lightcyan; font-size: 1em;'>"
		    + td + "</tr>"
	else
	    return "<tr>" + td + "</tr>"

    }

    function getTime() {
	var date = new Date();
	var seperator1 = "-";
	var year = date.getFullYear();
	var month = date.getMonth() + 1;
	var strDate = date.getDate();
	if (month >= 1 && month <= 9) {
	    month = "0" + month;
	}
	if (strDate >= 0 && strDate <= 9) {
	    strDate = "0" + strDate;
	}
	var currentdate = year + seperator1 + month + seperator1 + strDate;
	return currentdate;
    }
    function formatTime(date) {
	var seperator1 = "-";
	var year = date.getFullYear();
	var month = date.getMonth() + 1;
	var strDate = date.getDate();
	if (month >= 1 && month <= 9) {
	    month = "0" + month;
	}
	if (strDate >= 0 && strDate <= 9) {
	    strDate = "0" + strDate;
	}
	var currentdate = year + seperator1 + month + seperator1 + strDate;
	return currentdate;
    }
</script>