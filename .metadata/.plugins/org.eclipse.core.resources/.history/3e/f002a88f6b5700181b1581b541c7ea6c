var childwindow = new Array();

var trdnum = function() {
    return $("#dealId").val();
}

// 根据行权方法判断序列页面的操作
var SetMethod = "";
var SetIndex = "";
var thismarket = "";
var primarydealid = "";

var viewdata;
/* 计价button计数 */
var pct = 0;
/* 全局JS变量，保存市场惯例json对象 */
var jsonStr = JSON.parse($("#marketjson").text());
/* 全局JS变量，保存市场工具string对象 */
var inStr = $("#instrjson").text();
/* 初始化页面数据 */
$(function init() {

    // +++++++++++++++++++++++++ ↓ eqcm new code ↓++++++++++++++++++++
    
    //执行价格显示值和真实值
    $("#Strike").change(function(){
	$("#StrikeH").val($(this).val())
    })

    // 1.初始化台历、 行权工作日 、定价基准 from [jsonStr]
    var initArr = [ "exerCalendr", "exerBusdy", "paytCaldar" ]// , "setIndex"

    for ( var i in initArr) {
	$("." + initArr[i]).eq(0).append("<option selected='true' value='" + jsonStr[initArr[i]] + "'>" + jsonStr[initArr[i]] + "</option>")
    }
    // 2.定价基准
    setInStr($("#ValueDate").val());
    // 3.工作日
    setExerBusdy();

    // +++++++++++++++++++++++++ ↓ fx's old code ↓++++++++++++++++++++++

    // 清空
    window.onunload = function() {
	localStorage.clear();
    }

    // 格式化本金2{面值}
    $("input[name='notional']").change(function() {
	$(this).val(formatNumber($(this).val(), 2, true));
    })

    $("#effdate").bind("input propertychange", function() {
	alert();
	var v = $("#effdate").val()
	if (v == null || v == "" || v == undefined) {
	    return false;
	}
	// change paydate/expdate using newer data by ajax
	initExpAndPayDate()
    });

    $("#expdatelag").bind("input propertychange", function() {
	var v = $("#expdatelag").val()
	if (v == null || v == "" || v == undefined) {
	    return false;
	}
	// change paydate/expdate using newer data by ajax
	initExpAndPayDate()
    });

    $("#price").click(function() {
	price();
    });
    $("#price").mousedown(function() {

	$("#price").val("Pricing···");
	/*
	 * $("#price") .after( "<span id='ps'><font size=20 id='notice'
	 * color='green'>&nbsp;&nbsp;<b>Pricing···</b></font></span>")
	 */
    });
    $("#submittrd").mousedown(function() {

	$("#submittrd").css("color", "lightgreen")

	$('#submittrd').text('提交中···');

	/*
	 * setInterval(function litSlash() {
	 * setTimeout("$('#submittrd').text('提交中·')", 200);
	 * setTimeout("$('#submittrd').text('提交中··')", 200);
	 * setTimeout("$('#submittrd').text('提交中···')", 200); }, 600);
	 */

    });

    $("#lump").click(function() {
	lump();
	/* open("lump"); */
    });
    $("#leg").click(function() {
	paysched()
	/* open("leg"); */
    });

    // 簿记
    initBook();

})

/* init end */

function setInStr(date) {
    if (inStr != "NODATA") {

	$("#SetIndex").empty();

	// 过滤当前日期以前的选项
	var da = date.split("-");

	var a = parseInt(da[0] + da[1]);

	var A = inStr.split(",");
	for ( var i in A) {
	    if (parseInt("20" + A[i].split("_")[1]) > a) {
		$("#SetIndex").append("<option  value='" + A[i] + "'>" + A[i] + "</option>")
	    }

	}
    }
}

function setExerBusdy() {
    var initval = $("#ExpBusdy").val();
    var str = $("#exerBusdyStr").text()
    if (str != "NODATA") {

	$("#ExpBusdy").empty();

	var A = str.split(",");
	for ( var i in A) {
	    $("#ExpBusdy").append("<option  value='" + A[i] + "'>" + A[i] + "</option>")

	}
	$("#ExpBusdy").val(initval);
    }
}

/*
 * function expdateclick(){ var v=$("#effdate").val() var nv=$("#effdate").val()
 * if(v!=nv&&(nv!=null||nv!=''||nv!=undefined)){ //change paydate/expdate using
 * newer data by ajax initExpAndPayDate() } }
 */

/* function to init paydate/expdate using initial data by ajax */
function initExpAndPayDate() {
    // params array
    var url = "/deri-web/fxController.do?initPayAndExpDate"
    var array = []
    array.push(String($("#effdate").val()))
    array.push(String($("#box").val()))
    array.push(String($("#expdatelag").val()))
    array.push(String($("#effdate").val()))// 应该为计算后的行权日，暂时先传过去，后台取计算后的进行计算
    array.push(String($("#boxs").val()))
    array.push("2")// 时延暂固定为2
    $.ajax({
	type : 'POST',
	data : {
	    "array" : array
	},
	traditional : true,
	url : url,
	success : function(data) {
	    $.each(data, function(k, v) {
		if (k == "obj") {
		    $("#expdate").val(v[0]);
		    $("#paydate").val(v[1])
		}
	    });
	},
	dataType : 'json'
    });
}

function boxsf() {
    $('#boxs').empty()
    $('#cutcity').toggle();
}

/* setmethod control */
function setmethod(select) {
    if (select == "Physical") {
	$("#setindex").append("<option value=' '></option>")
	$("#setindex option:last").attr("selected", true)
	$("#setindex").attr("disabled", true).addClass("setmothod");
    } else {
	$("#setindex").attr("disabled", false).removeClass("setmothod");
	$("#setindex option[value=' ']").remove()
	$("#setindex option:first").attr("selected", true)
    }
}
/* function for when market change. */
function change(marketname) {
    location.href = "/deri-web/eqcmController.do?toEqcmOptn&market=" + marketname;
}
/* 定价基准改变函数 由change()调用 */
function findinstrument(marketname) {
    thismarket = marketname;
    var i = 0;
    $.ajax({
	url : '/deri-web/fxFxoEntityController.do?findTenor&marketname=' + marketname,
	type : 'GET',
	dataType : 'json',
	timeout : 1000,
	cache : false,
	beforeSend : LoadFunction, // 加载执行方法
	error : erryFunction, // 错误执行方法
	success : succFunction
    // 成功执行方法
    })
    function LoadFunction() {
	$("#list").html("<font size=20 id='notice' color='green'><b>Loading···</b></font>");
    }
    function erryFunction() {
	// alert("服务器连接错误！");
	// 尝试三次
	if (i < 3) {
	    $("#list").html("<font size=20 id='notice' color='red'><b>Load Error,[" + i + 1 + "] ReConnect</b></font>");
	    findinstrument(thismarket);
	} else
	    alert("服务器连接错误！");

	i++;
    }
    function succFunction(tt) {
	$.each(tt, function(key, value) {
	    if (key == "obj") {
		$("#setindex").empty();
		for (j = 0, len = value.length; j < len; j++) {
		    index = marketname + "_" + value[j]
		    $("#setindex").append("<option value='" + index + "'>" + index + "</option>")
		}
		if ($("#setmethod").val() == "Physical") {
		    $("#setindex").append("<option value=' '></option>")
		    $("#setindex option:last").attr("selected", true)
		} else {
		    if (SetIndex != "") {// 说明是查询
			$('#setindex').val(SetIndex);
		    } else
			// 新增操作
			$("#setindex option[index=1]").attr("selected", true)
		}
	    }
	});
	$("#list").html('');
    }
}
/* system now time. */
function gettime() {
    var date = new Date();
    var seperator1 = "-";
    var year = date.getFullYear();
    var month = date.getMonth() + 1;
    var strDate = date.getDate();
    if (month >= 1 && month <= 9) {
	month = "0" + month;
    }
    if (strDate >= 0 && strDate <= 9) {
	strDate = "0" + strDate;
    }
    var currentdate = year + seperator1 + month + seperator1 + strDate;
    return currentdate;
}

// 计价成功提醒
function pricenotice(f, s) {
    $("#ps").remove()
    if (f === true) {

	/*
	 * $("#price").after( "<font size=16 id='notice' color='green'><b>" +
	 * s + "</b></font>")
	 */
	$("#price").val("SUCCESS")
	setTimeout("$(\"#price\").val(\"计价\")", 1500);
    } else {
	$("#price").val("FAILED")
	setTimeout("$(\"#price\").val(\"计价\")", 1500);
	$("#price").after("<br><font size=16 id='notice' color='red'><b>" + s + "</b></font>")
	setTimeout("$('#notice').remove()", 15000);
    }
}

function LoadFunctionPrice() {

}

function price() {

    $('#notice').remove()
    $('#lumpview').hide();
    pct++;

    $('#lumpdiv').remove();
    $.ajax({
	type : "POST", // 提交的方法
	url : "/deri-web/eqcmController.do?price", // 提交的地址
	data : $('#form').serialize() + "&lump=" + getlump() + "&env="
	// conv
	// 改变市场传过来的市场惯例
	+ getenv() + "&resetsched=" + getresetSched() + "&conv=" + $("#marketjson").text(),
	async : false,
	beforeSend : LoadFunctionPrice,
	error : function(request) { // 失败的话
	    pricenotice(false, '&nbsp;&nbsp;Connection ERROR,Price Failed.')
	},
	success : function(data) {// 成功

	    console.log(data.msg)

	    if (data.msg != 'OK') {
		pricenotice(false, data.msg + '<br>Price Failed.')
	    } else {

		console.log(data.obj)
		console.log("priced.")

		// show submit button.
		$("#submittrd").show();

		pricenotice(true, '&nbsp;&nbsp;Price Success!')

		/*
		 * eqcm new code,create page by js
		 * defined at priced.js
		 * 
		 * ***begin***
		 */
		afterPrice(data.obj,pct);

		/*
		 * **end***
		 */

		$("#leg").show();
		// storage env's init html.
	    }
	},
	dataType : "json"
    });

}

/*
 * function lump(){ if($('#lumpview').html()==undefined){ $("body").after("<div
 * id='lumpdiv'></div>");
 * $('#lumpdiv').load('webpage/com/finanstar/fx/price/lump.jsp', function() {
 * $(".table").hide(); $('#lumpview').show(); }); }else{ showlump(); } }
 */

function getlump() {
    return localStorage.getItem('eqcmlump.' + trdnum())
}
function getenv() {
    return localStorage.getItem('eqcmenv.' + trdnum())
}
function getresetSched() {
    return localStorage.getItem('eqcmrsh.' + trdnum())
}
function getpaysched() {
    return localStorage.getItem('eqcmpaysched.' + trdnum())
}

function lump() {
    if (childwindow['l.' + trdnum()] != undefined)
	childwindow['l.' + trdnum()].close();
    childwindow['l.' + trdnum()] = window.open('webpage/com/finanstar/eqcm/price/lump.jsp?id=' + trdnum()+"&date="+$("#ValueDate").val());
}
function queryDeal() {
    if (childwindow['ql'] != undefined)
	childwindow['ql'].close();
    childwindow['ql'] = window.open("/deri-web/fxController.do?finddeallist&option=1");
}
function paysched() {
    // 判断行权方法
    // 从上一次的生成文件中找到SetMethod
    // 判断 是否为 Physical
    // param
    /* transform sched or not. */
    hasSched = 'No';
    // var[SetMethod] defined at [fxo_price_return_data.jsp] after price.
    if (SetMethod != 'Physical') {
	hasSched = 'Yes';
    }

    if (childwindow['p.' + trdnum()] != undefined)
	childwindow['p.' + trdnum()].close();
    childwindow['p.' + trdnum()] = window.open('webpage/com/finanstar/eqcm/price/leg.jsp?hasSched=' + hasSched + '&id=' + trdnum());

}
function environment() {
    if (childwindow['e.' + trdnum()] != undefined)
	childwindow['e.' + trdnum()].close();
    childwindow['e.' + trdnum()] = window.open("webpage/com/finanstar/eqcm/price/environment.jsp?id=" + trdnum());
    /*
     * $(".table").hide(); $(".out").hide(); $(".env").show();
     */
}

/*
 * function open(page){ alert(page)
 * if(childwindow[page+"."+trdnum]!=undefined)childwindow[page+"."+trdnum].close();
 * childwindow[page+"."+trdnum]=window.open("webpage/com/finanstar/fx/price/"+page+".jsp?id="+trdnum); }
 */

function closechild() {
    if (childwindow['l.' + trdnum()] != undefined)
	childwindow['l.' + trdnum()].close();
    if (childwindow['p.' + trdnum()] != undefined)
	childwindow['p.' + trdnum()].close();
    if (childwindow['e.' + trdnum()] != undefined)
	childwindow['e.' + trdnum()].close();
}

function showlump() {
    $('#lumpview').toggle();
    $(".table").toggle();
}
function showbook() {
    $('#bookt').toggle();
    var str = '隐藏簿记';
    if ($('#bookt').is(":hidden")) {
	str = '显示簿记';
	// 显示编号
	$(".inner-up-1").show();
    } else {
	// 隐藏编号
	$(".inner-up-1").hide();
    }
    $('#bookbut').text(str);
}

$.fn.serializeObject = function() {
    var o = {};
    var a = this.serializeArray();
    $.each(a, function() {
	if (o[this.name]) {
	    if (!o[this.name].push) {
		o[this.name] = [ o[this.name] ];
	    }
	    o[this.name].push(this.value || '');
	} else {
	    o[this.name] = this.value || '';
	}
    });
    return o;
}

/** format float and thousand. */
function formatNumber(num, cent, isThousand) {

    num = num.toString().replace(/\$|\,/g, '');

    // 检查传入数值为数值类型
    if (isNaN(num))
	num = "0";

    // 获取符号(正/负数)
    sign = (num == (num = Math.abs(num)));

    num = Math.floor(num * Math.pow(10, cent) + 0.50000000001); // 把指定的小数位先转换成整数.多余的小数位四舍五入
    cents = num % Math.pow(10, cent); // 求出小数位数值
    num = Math.floor(num / Math.pow(10, cent)).toString(); // 求出整数位数值
    cents = cents.toString(); // 把小数位转换成字符串,以便求小数位长度

    // 补足小数位到指定的位数
    while (cents.length < cent)
	cents = "0" + cents;

    if (isThousand) {
	// 对整数部分进行千分位格式化.
	for (var i = 0; i < Math.floor((num.length - (1 + i)) / 3); i++)
	    num = num.substring(0, num.length - (4 * i + 3)) + ',' + num.substring(num.length - (4 * i + 3));
    }

    if (cent > 0)
	return (((sign) ? '' : '-') + num + '.' + cents);
    else
	return (((sign) ? '' : '-') + num);
}
