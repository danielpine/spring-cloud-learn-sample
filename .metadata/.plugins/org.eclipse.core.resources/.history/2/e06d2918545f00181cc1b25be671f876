<!-- daniel create at 2018-05-24.-->
<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<!DOCTYPE html>
<html>
<head>
<title>基准更新 波动率统计</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script type="text/javascript"
	src="/deri-web/plug-in/jquery/jquery-1.8.3.js"></script>
<link media="screen" rel="stylesheet"
	href="/deri-web/plug-in/finanstar/css/htmlDatePicker.css" />
<script type="text/javascript"
	src="/deri-web/plug-in/finanstar/js/htmlDatePicker.js"></script>
<link media="screen" rel="stylesheet"
	href="/deri-web/plug-in/finanstar/css/body.css" />
<style type="text/css">
h1 {
	margin: 0 auto;
}

.outer {
	width: 800px;
	margin-top: 20px;
	border: 1 solid red;
}

.title {
	font-size: 2em;
	font-family: arial, 'hiragino sans gb', 'microsoft yahei', 'Simsun',
		sans-serif;
}

li {
	color: green;
	font-size: 1.5em;
}

td {
	border: solid black;
	border-width: 0px 1px 1px 0px;
	padding: 1px 0px;
}

.but {
	width: 500px;
}

button {
	width: 120px;
	height: 30px;
	background: orange;
	margin-left: 20px;
}

button:hover {
	background: green;
	color: yellow;
}

table {
	width: 630px;
	border: solid black;
	border-width: 0.5px 0px 0px 0.5px;
}

.tips {
	margin-left: 20px;
	margin-top: 30px;
}

.batchbottom {
	margin-left: 35px;
}
</style>
</head>

<body>

	<div style="margin-top: 45px; width: 800px;">
		<div style="margin-left: 220px;">
			<h1 class="title">基准更新 波动率统计</h1>
		</div>
		<div class="outer">
			<div align="left" class="l">
				<font style="color: blue; width: 80px; text-align: right;">
					计价日:</font>
				<input type='text' name='ValueDate' id='ValueDate' value=''
					onClick="GetDate(this)"
					style='width: 100px; height: 22px; background: orange; text-align: center; font-size: 0.9em;' />
			</div>
		</div>
		<div class="outer">
			<div align="left" class="l">
				&nbsp;&nbsp;&nbsp;&nbsp;<font
					style="color: blue; width: 80px; text-align: right;">市场:</font> <select
					id='Book' name='Book'
					style='width: 500px; height: 23px; font-size: 0.9em;'>
					<c:forEach items="${convList  }" var="c">
						<c:set value="${c.name }@${c.exchangeCode }@${c.chineseName }"
							var="nameExchangeCodeChineseName"></c:set>
						<option value='${nameExchangeCodeChineseName }'>${nameExchangeCodeChineseName }</option>
					</c:forEach>
					<option value='ALL'>ALL</option>
				</select>
			</div>
		</div>
		<div class="outer">
			<div align="left" class="but">
				<div class="batchbottom" align="left">
					<button type="button" id="UpdateIndex">UpdateIndex</button>
					<button type="button" id="GenVol">GenVol</button>
					<!-- <input type="button" id="Read" value="Read" />
					<input type="button" id="Save" value="Save" /> -->
					<br>
					<div class="tips">
						<!-- 
					http://pic.yeyetv.com/20150915/5857ffdd0d03fd27a06340273a04ca41.gif
					http://pic.yeyetv.com/20150915/696f0bd4bd4069b28601270c292d0252.gif -->
						<span style="height: 32px;"><img id="runimg"
							align="absmiddle"
							style="margin: 0 auto; display: none; width: 32px; height: 32px;"
							src="http://pic.yeyetv.com/20150915/696f0bd4bd4069b28601270c292d0252.gif">
							&nbsp;&nbsp;<span id="tips"></span> </span>
					</div>

				</div>
			</div>
		</div>
		<!-- <div align="center" style="height: 30px; width: 300px;">
			
		</div> -->
		<div class="outer" style="display: none">
			<table id="datatable" cellspacing="0">
				<tr height="30">
					<td width="100" class="price"
						style="background: lightcyan; text-align: center; font-size: 0.9em;">Date</td>
					<td width="100" class="price"
						style="background: lightcyan; text-align: center; font-size: 0.9em;">期限
					</td>
					<td width="100" class="price"
						style="background: lightcyan; text-align: center; font-size: 0.9em;">计价</td>
					<td width="100" class="price"
						style="background: lightcyan; text-align: center; font-size: 0.9em;">市场</td>
					<td width="100" class="price"
						style="background: lightcyan; text-align: center; font-size: 0.9em;">Xtick</td>
					<td width="130" class="price"
						style="background: lightcyan; text-align: center; font-size: 0.9em;">类型</td>
				</tr>
				<tbody id="tbody"></tbody>
			</table>
		</div>
	</div>
	<div id="view"></div>
	<ul id="info" style="margin-top: 20px; margin-left: 40px;"></ul>
</body>
<script type="text/javascript">

	var isSecCount=true;
	
	var totalSec=0;
	
    childwindow = []
    var data;
    $(function() {

	$("#ValueDate").val(getTime())

	$("#batA").show()

	$("#UpdateIndex")
		.click(
			function() {
			    console.log($(this).html() + ":"
				    + $("#ValueDate").val().replace(/\-/g, "")
				    + ":" + $("#Book").val());
			    var info = $(this).html() + ":"
				    + $("#ValueDate").val().replace(/\-/g, "")
				    + ":" + $("#Book").val();

			    $
				    .ajax({
					type : "POST", // 提交的方法
					url : "/deri-web/dataController.do?doUpdateIndex", // 提交的地址
					data : "&info=" + info,
					//async : false,
					error : function(request) { // 失败的话
					},
					success : function(j) {// 成功
					    $("#runimg").hide()
					    var newTenorSavedArray = j.obj

					    if (newTenorSavedArray.length == 0) {
						$("#tips")
							.html(
								"<font color='blue'>Not Found Any New Tenor.</font>")
					    } else {

						html = ""
						for ( var i in newTenorSavedArray) {
						    html += "<font color='green'>Insert New Tenor:</font><font color='green'>"
							    + newTenorSavedArray[i]
							    + "</font><br>"
						}
						$("#tips").html(html)
					    }

					},
					dataType : "json"
				    });

			});

	$("#Save")
		.click(
			function() {

			    console.log(data.toString())

			    $
				    .ajax({
					type : "POST", // 提交的方法
					url : "/deri-web/dataController.do?doDataCrawlerSave&type=CNYFR", // 提交的地址
					data : "&data=" + data.toString(),
					async : false,
					error : function(request) { // 失败的话
					},
					success : function(j) {// 成功
					    
					    isSecCount=false;
					    totalSec=0;
					    
					$("#tips")
						    .html(
							    "<font color='green'>"
								    + j.obj
								    + " Lines Saved.</font>")
					    // setTimeout("$(\"#tips\").html('')", 3500);
					},
					dataType : "json"
				    });
			});

	$("#UpdateIndex").mousedown(function() {
	    $("#tips").html("<font color='green'>Running Used &nbsp;<font color='blue' id='sec'></font>&nbsp; s</font>")
	    while(getisSecCount()){
		secCount()
	    $("#sec").text(totalSec);
	    }
	    $("#runimg").show()
	});
	$("#Read").mousedown(function() {
	    $("#tips").html("<font color='green'>Reading</font>")
	});
	
	

    });
    
    function secCount(){
	setTimeout(() => {
	    totalSec++;
	}, 1000);
    }
    
    function getisSecCount(){
	return isSecCount;
    }

    function getTime() {
	var date = new Date();
	var seperator1 = "-";
	var year = date.getFullYear();
	var month = date.getMonth() + 1;
	var strDate = date.getDate();
	if (month >= 1 && month <= 9) {
	    month = "0" + month;
	}
	if (strDate >= 0 && strDate <= 9) {
	    strDate = "0" + strDate;
	}
	var currentdate = year + seperator1 + month + seperator1 + strDate;
	return currentdate;
    }
</script>