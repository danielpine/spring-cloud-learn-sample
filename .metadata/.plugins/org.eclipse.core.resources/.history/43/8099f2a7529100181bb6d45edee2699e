//初使执行
function initLogin() {
    // alert = showMsg
    CheckUpassSetup(false);// U盘认证

}

// U盘认证开始
function CheckUpassSetup(showTip) {

    if (IEVersion() === -1) {
	$("#password").prop("disabled", "disabled")
	$("#userName").prop("disabled", "disabled")
	$("#compName").prop("disabled", "disabled")
	showMsg(
		"为了您的数据安全，请使用 <font color='lightblue'>Internet Explorer</font> 浏览器打开本页面！",
		"lightgreen");
	return false;
    } else {
	if (ComponentExists("icanUpass5.WebuPassMain5")) {
	    // 开始验证设备
	    if (showTip == true) {
		showMsg("您的计算机已安装密钥驱动！", "orange");
	    }
	    return true;
	} else {
	    // 没有驱动
	    showMsg("您的计算机中未安装密钥驱动，请下载安装密钥驱动，然后重新打开本页面！", "orange");
	    window.opener = null;
	    $("#download_install").show()
	    $("#password").prop("disabled", "disabled")

	    return false;
	}
    }

}

// 检查ActiveX是否存在
function ComponentExists(comStr) {
    try {
	var r;
	ActiveX = new ActiveXObject(comStr);
    } catch (e) {
	return false;
    }
    return true;
}
// 初始化设备
function InitDrv_Validate() {
    var s;
    s = new Date();
    var SysPKI;
    // PKI内容由U盘认证发布工具生成，用户不允许修改内容;
    SysPKI = "MjIgMjkgOUYgM0IgNkYgQTEgMEQgNDcgMkUgQjUgQUUgNEYgNTYgN0YgQjEgREQgODIgOUIgNTUgQCMlRTYgRkYgRDEgOUYgRTIgREMgRDcgMjAgNzkgNEQgRUEgODIgNEIgMjkgNTkgOTQgNzMgRjEgNTcgQCMl";
    InitDrv_Validate_Result = iCanWebuPass5.uPassFunMain.InitWebuPass(SysPKI,
	    s.date);
    if (InitDrv_Validate_Result == false) {
	$("#InitDrv").val("0");
	showErr(iCanWebuPass5.uPassFunMain.Get_strErr);
	return false;
    } else {
	// 初始化完成后，赋值成功标志
	var DrvIDString = iCanWebuPass5.uPassFunMain.Get_strDrvKeyNumber;
	$("#InitDrv").val("1");
	return true;
    }
}
// 读取Key
function ReadKey() {
    if (iCanWebuPass5.uPassFunMain.ReadKey(false, "", true) == false) {
	// 读取设备失败，显示错误
	var ErrString = iCanWebuPass5.uPassFunMain.Get_strErr;
	$('#checkok').remove()
	$('#checkokbox').remove()
	if (ErrString.substring(0, 3) == "306") {
	    showErr(ErrString);
	} else {
	    var errCode = ErrString.substring(0, 3)
	    switch (errCode) {
	    case "704":
		showMsg("请在Internet Explore浏览器<br>" + "设置-internet选项-安全-受信任的站点-站点<br>"
			+ "添加 > http://deri.finanstar.cn<br>" + "确定-应用<br>重新打开Internet Explore浏览器",
			"lightgreen");
		break;
	    case "703":
		showErr("请格式化Ukey 重新插拔 并刷新页面！");
		break;

	    case "302":
		showErr("请插入您的Ukey重新登录！");
		break;

	    default:
		showErr(ErrString);
		break;
	    }

	}
	return false;

    } else {
	// 读取设备成功，取返回值赋值页面对象中
	var DrvSavedText = iCanWebuPass5.uPassFunMain.Get_StrDrvSavedText;
	var DrvIDString = iCanWebuPass5.uPassFunMain.Get_strDrvKeyNumber
	$("#Key").val(DrvSavedText); // 读出认证内容
	$("#DrvID").val(DrvIDString); // 返回设备ID
	return true;
    }
}

// 执行登录
function ExecuteLogin() {
    // 先完成初始化过程
    // showMsg("初始化U-Key···", "lightblue")
    if (InitDrv_Validate() == false) {
	return false;
    }

    // 开始读取设备信息
    if (ReadKey() == false) {
	return false;
    }
    return true;
}

// 普通用户登录 ukey 验证
function checkUpass() {

    if (ExecuteLogin() == false) {
	// window.location.reload();
	return false;
    }

    // 判断初始化是否成功
    var BlnInitDrv = $("#InitDrv").val();
    if (BlnInitDrv == null || BlnInitDrv.length == 0 || BlnInitDrv == "0") {
	showErr("初始化失败，请重新刷新页面再试！");
	window.location.reload();
	return false;
    }

    // 判断是否已经执行了读设备操作，并且正确返回了认证文本
    var Key = $("#Key").val();

    var DrvID = $("#DrvID").val();
    // alert(DrvID)
    if ((Key == null || Key.length == 0)
	    && (DrvID == null || DrvID.length == 0)) {
	showErr("没有读取到认证设备信息，轻检查你插入的认证设备是否正确！");
	window.location.reload();
	return false;
    } else {
	$("#thiskey").html(Key)
	// showMsg("Ukey认证成功！", "lightblue");
	showCheckOkMsg()
    }

    return true;
}

function showMsg(msg, color) {
    drawDivNColor(msg, color)
    $('#overlay').fadeIn('fast', function() {
	$('#box').animate({
	    'top' : '40%',
	    "width" : "30%",
	    "left" : '43%'

	}, 0);
	// $("#mess").html();
	if (color != 'lightgreen') {
	    setTimeout("tishiclose()", 3500);// 2秒消失，可以改动
	} else {
	    $("#overlay").show()
	}

    });
}
function showCheckOkMsg() {
    $('#checkok').fadeIn('fast', function() {
	$('#checkokbox').animate({
	    'top' : '40%',
	    "width" : "30%",
	    "left" : '45%'

	}, 0);
	// $("#mess").html();
	setTimeout("tipclose('checkokbox','checkok')", 3500);// 2秒消失，可以改动

    });

}

function showErr(msg) {
    drawDivNColor(msg, "orange")
    $('#overlay').fadeIn('fast', function() {
	$('#box').animate({
	    'top' : '40%',
	    "width" : "30%",
	    "left" : '45%'

	}, 0);
	// $("#mess").html();
	setTimeout("tishiclose()", 3500);// 2秒消失，可以改动

    });
}

function tishiclose() {
    $('#box').animate({
	'top' : '-100%'
    }, 0, function() {
	$('#overlay').fadeOut('fast');
    });
}
function tipclose(box, overlay) {
    $('#' + box).animate({
	'top' : '-100%'
    }, 0, function() {
	$('#' + overlay).fadeOut('fast');
    });
}

function IEVersion() {
    var userAgent = navigator.userAgent; // 取得浏览器的userAgent字符串
    var isIE = userAgent.indexOf("compatible") > -1
	    && userAgent.indexOf("MSIE") > -1; // 判断是否IE<11浏览器
    var isEdge = userAgent.indexOf("Edge") > -1 && !isIE; // 判断是否IE的Edge浏览器
    var isIE11 = userAgent.indexOf('Trident') > -1
	    && userAgent.indexOf("rv:11.0") > -1;
    if (isIE) {
	var reIE = new RegExp("MSIE (\\d+\\.\\d+);");
	reIE.test(userAgent);
	var fIEVersion = parseFloat(RegExp["$1"]);
	if (fIEVersion == 7) {
	    return 7;
	} else if (fIEVersion == 8) {
	    return 8;
	} else if (fIEVersion == 9) {
	    return 9;
	} else if (fIEVersion == 10) {
	    return 10;
	} else {
	    return 6;// IE版本<=7
	}
    } else if (isEdge) {
	return 'edge';// edge
    } else if (isIE11) {
	return 11; // IE11
    } else {
	return -1;// 不是ie浏览器
    }
}
