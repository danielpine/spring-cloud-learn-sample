/** format float and thousand. */
function formatNumber(num, cent, isThousand) {

	num = num.toString().replace(/\$|\,/g, '');

	// 检查传入数值为数值类型
	if (isNaN(num))
		num = "0";

	// 获取符号(正/负数)
	sign = (num == (num = Math.abs(num)));

	num = Math.floor(num * Math.pow(10, cent) + 0.50000000001); // 把指定的小数位先转换成整数.多余的小数位四舍五入
	cents = num % Math.pow(10, cent); // 求出小数位数值
	num = Math.floor(num / Math.pow(10, cent)).toString(); // 求出整数位数值
	cents = cents.toString(); // 把小数位转换成字符串,以便求小数位长度

	// 补足小数位到指定的位数
	while (cents.length < cent)
		cents = "0" + cents;

	if (isThousand) {
		// 对整数部分进行千分位格式化.
		for (var i = 0; i < Math.floor((num.length - (1 + i)) / 3); i++)
			num = num.substring(0, num.length - (4 * i + 3)) + ','
					+ num.substring(num.length - (4 * i + 3));
	}

	if (cent > 0)
		return (((sign) ? '' : '-') + num + '.' + cents);
	else
		return (((sign) ? '' : '-') + num);
}

// format date.
function formatDate(value, cut) {
	var value1 = value.trim();

	if (value.length == 8) {
		return value.substring(0, 4) + cut + value.substring(4, 6) + cut
				+ value.substring(6, 8);
	} else if (value.length == 6) {
		return value.substring(0, 4) + cut + value.substring(4, 6);
	} else {
		return value1;
	}
}

/* init end */
function afterSearch() {
    // 处理查询
    var query = $("#query").html();
    if (query != "") {

	query = JSON.parse(query)
	// 页面

	// 隐藏域赋值 方便提交数据传输
	$("#DealType").val(query.deal.dealType)

	// 隐藏域赋值 方便提交数据传输
	$("#Msgs").val(query.deal.msgs)

	// leg
	trade = JSON.parse(query.sched.tradeTerm)
	sched = trade.Sched
	storagesched("eqcmsched." + query.deal.dealId)

	// lump
	// update local lump
	lumpPay = trade.LumpPay
	
	DealId=query.deal.dealId
	updateLump()

	// show submit button.
	$("#submittrd").show();
	$("#deletetrd").show();

	// 更新簿记显示
	// 更新页面数据
	updateBook(query.deal);
	// 交易id 主键
	primarydealid = query.deal.id;

	$("#verifiedtrd").show()
	$("#leg").show()

	$.each(trade, function(k, v) {
	    var dateIndex = k.indexOf('Date');
	    if (v != "0" && dateIndex > 0) {
		var s = "-"
		var y = v.substring(0, 4);
		var m = v.substring(4, 6);
		var d = v.substring(6, 8);
		v = y + s + m + s + d;
	    }
	    if (k == "Strike" || k == "Notional" || k == "FaceAmt") {

		// Function -> formatNumber(num, cent, isThousand)
		// Defined at optn.js L:464
		v = formatNumber(v, 2, true)
		// Strike's true value
		if (k == "Strike") {
		    $("StrikeH").val(v)
		}
	    }
	    
	    if (k == "SetMethod") {

		    if (v != "Cash") {
			setmethod($("#SetMethod").val())
		    }
		}

	    $("#" + k).val(v)
	})

	// 动态生成显示基本报告
	$("#envA").hide()
	$("#envA").attr("href", "JavaScript:alert('请先计价!')")
	var outcome = JSON.parse(query.sched.outcome)

	$("#view").show();

	$("#tbody").empty()

	var tr = $("#clonetr").clone();

	// outcome : DealValue OptnValue LumpValue SwapValue

	var Val = [ "SwapValue", "OptnValue", "LumpValue", "DealValue" ];

	var html = "<tr><th>现值 " + outcome.PvCcy + "</th>" + "<td>"
		+ outcome.SwapValue.PV + "</td>" + "<td>"
		+ outcome.OptnValue.PV + "</td>" + "<td>"
		+ outcome.LumpValue.PV + "</td>" + "<td>"
		+ outcome.DealValue.PV + "</td></tr>"

	$("#tbody").append(html)
	var sv = outcome.SwapValue.CF;
	var ov = outcome.OptnValue.CF;
	var lv = outcome.LumpValue.CF;
	var dv = outcome.DealValue.CF;

	for (var i = 0; i < parseInt(lv.N); i++) {
	    var k = "P" + i
	    // ''.replace("CF", "现金流")
	    var h = lv[k].replace("CF", "现金流")

	    html = "<tr><th>" + h.split("~")[0] + "</th>" + "<td>"
		    + sv[k].split("~")[1] + "</td>" + "<td>"
		    + ov[k].split("~")[1] + "</td>" + "<td>"
		    + lv[k].split("~")[1] + "</td>" + "<td>"
		    + dv[k].split("~")[1] + "</td></tr>"

	    $("#tbody").append(html)

	}

	// print risk tr

	sv = outcome.SwapValue.Risk;
	ov = outcome.OptnValue.Risk;
	lv = outcome.LumpValue.Risk;
	dv = outcome.DealValue.Risk;

	for (var i = 0; i < parseInt(lv.Num); i++) {
	    var k = "P." + i

	    html = "<tr>" + "<th>" + lv[k].split("~")[0] + "</th>" + "<td>"
		    + sv[k].split("~")[1] + "</td>" + "<td>"
		    + ov[k].split("~")[1] + "</td>" + "<td>"
		    + lv[k].split("~")[1] + "</td>" + "<td>"
		    + dv[k].split("~")[1] + "</td></tr>"

	    $("#tbody").append(html)

	}
	
	    // 是否显示恢复按钮
	    var stat=$("#searchStatus").val()
	    if(stat=="Pending"){
		$("#submittrd").css("color","black")
		$("#deletetrd").css("color","black")
	    }else if(stat=="Deleted"||stat=="NotNew"){
		$("#recoverytrd").css("color","black")
		$("#verifiedtrd").css("color","black")
		$("#submittrd").css("color","black")
		$("#deletetrd").css("color","black")
	    }else if(stat=="Verified"){
		$("#recoverytrd").css("color","black")
		$("#verifiedtrd").css("color","black")
	    }else if(stat=="Modified"||stat=="New"){
		$("#recoverytrd").css("color","black")
		
	    }

	console.log(query.deal)
	console.log(query.sched)
    }
}

function datefmt(fmt, date) { // author: meizz
	date = new Date(date)
	var o = {
		"M+" : date.getMonth() + 1, // 月份
		"d+" : date.getDate(), // 日
		"h+" : date.getHours(), // 小时
		"m+" : date.getMinutes(), // 分
		"s+" : date.getSeconds(), // 秒
		"q+" : Math.floor((date.getMonth() + 3) / 3), // 季度
		"S" : date.getMilliseconds()
	// 毫秒
	};
	if (/(y+)/.test(fmt))
		fmt = fmt.replace(RegExp.$1, (date.getFullYear() + "")
				.substr(4 - RegExp.$1.length));
	for ( var k in o)
		if (new RegExp("(" + k + ")").test(fmt))
			fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k])
					: (("00" + o[k]).substr(("" + o[k]).length)));
	return fmt;
}

function initHrefColor(){
    // 是否显示恢复按钮
    var stat=$("#status").val()
    if(stat=="Pending"){
	$("#submittrd").css("color","black")
	$("#deletetrd").css("color","black")
	$("#submittrd").parent().css("background","gray")
	$("#deletetrd").parent().css("background","gray")
    }else if(stat=="Deleted"||stat=="NotNew"){
	$("#recoverytrd").css("color","black")
	$("#verifiedtrd").css("color","black")
	$("#submittrd").css("color","black")
	$("#deletetrd").css("color","black")
	$("#recoverytrd").parent().css("background","gray")
	$("#verifiedtrd").parent().css("background","gray")
	$("#submittrd") . parent().css("background","gray")
	$("#deletetrd")  .parent().css("background","gray")
    }else if(stat=="Verified"){
	$("#recoverytrd").css("color","black")
	$("#recoverytrd").parent().css("background","gray")
	$("#verifiedtrd").css("color","black")
	$("#verifiedtrd").parent().css("background","gray")
    }else if(stat=="Modified"||stat=="New"){
	$("#recoverytrd").css("color","black")
	$("#recoverytrd").parent().css("background","gray")
	
    }else{
	    $("#recoverytrd").css("color","black")
	    $("#verifiedtrd").css("color","black")
	    $("#deletetrd").css("color","black")
	    $("#recoverytrd").parent().css("background","gray")
	    $("#verifiedtrd").parent().css("background","gray")
	    $("#deletetrd")  .parent().css("background","gray")
    }
}

