<!-- daniel create at 2018-05-18-->
<%@ page language="java" import="java.util.*"
	contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@include file="/context/mytags.jsp"%>
<%-- <%@include file="/webpage/com/finanstar/eqcm/header.jsp"%> --%>
<!DOCTYPE html>
<html>
<head>
<title>${j.batchType }Report</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<link media="screen" rel="stylesheet"
	href="plug-in/finanstar/css/fx-navigation.css" />
<script type="text/javascript"
	src="/deri-web/plug-in/jquery/jquery-1.8.3.js"></script>
<style type="text/css">
body {
	margin: 0px 10px;
	background: lightyellow;
	font-family: "Helvetica", "Arial", "微软雅黑", "宋体", sans-serif;
}

.title {
	font-size: 2em;
	font-family: 'microsoft yahei', sans-serif;
	color: blue;
}

select {
	width: 140px;
	height: 26px;
	background: orange;
	font-size: 1.3em;
	padding: 0px;
	line-height: 30px;
}

button {
	width: 120px;
	height: 26px;
	background: orange;
	font-size: 1.3em;
	margin-left: 50px;
}

.btt {
	width: 12430px;
	margin-top: 50px;
}

.report table {
	border-width: 0px 0px 1px 1px;
	margin-left: 20px;
	margin-right: 20px;
	border-style: none none solid solid;
	border-width: 1px;
}

.report td {
	border: solid black;
	border-width: 1px 1px 0px 0px;
}

.sum td {
	background: lightgreen;
	height: 30px;
	font-size: 1.25em;
	text-align: right;
	padding-right: 5px;
}

.head td {
	background: lightcyan;
	font-size: 0.9em;
	text-align: center;
	height: 20px;
	width: 120px;
}

.btt font {
	margin-left: 30px;
	font-size: 1.3em;
	color: blue;
}

.report {
	margin-top: 30px;
}

.tbody {
	height: 30px;
	font-size: 1.25em;
	text-align: right;
	padding-right: 5px;
}

.rate {
	background: lightgray;
	font-size: 1em;
	text-align: right;
	padding-right: 20px;
}
</style>
</head>

<body>
	<c:if test="${not empty msg }">
	${msg }
	</c:if>
	<c:if test="${empty msg }">
		<div class="btt">
			<textarea id="optionjson" hidden="true">${j.optionjson }</textarea>
			<textarea id="optiondeful" hidden="true">${j.ro.comp },${j.ro.desk },${j.ro.book },${j.ro.market },${j.ro.valueDate }</textarea>
			<div style="margin-left: 520px;">
				<h1 class="title">${j.reportname }</h1>
			</div>
			<form id='form'
				action="eqcmController.do?toreport&batchType=${j.batchType }"
				method="post">
				<div style="margin-top: 30px; margin-left: 5px;">
					<font> 部门 &nbsp;</font>
					<select id='1' name='comp' style='width: 150px;'>
					</select>
					<font> 交易处室 &nbsp;</font>
					<select id='2' name='desk' style='width: 180px;'>
					</select>
					<font> 账户 &nbsp;</font>
					<select id='3' name='book' style='width: 180px;'>
					</select>
					<font> 市场 &nbsp;</font>
					<select id='4' name='market' style='width: 150px;'>
					</select>
					<font> 报告日期 &nbsp;</font>
					<select id='5' name='valueDate' style='width: 120px;'>
					</select>
					<button type="button" onclick="$('#form').submit()">提交</button>
				</div>
			</form>

		</div>
		<div class="report">
			<table class="price" style="width: ${j.tableWidth}px;"
				cellspacing="0" cellpadding="0">
				<tr style="height: 30px" id="r0" class="rate">
					<td></td>
					<c:forEach items="${j.Rate0 }" var="h" varStatus="s">
						<c:choose>
							<c:when test="${s.count<=12 }">
								<c:if test="${s.count==12}">
									<c:set value="Price0" var="show1"></c:set>
								</c:if>
								<td style="font-size: 1.25em; text-align: center;">${show1 }</td>
							</c:when>
							<c:otherwise>
								<c:set value="r0-${s.count }" var="index"></c:set>
								<td
									style="font-size: 1.25em; font-aligh: right; padding-right: 50px;"
									id="${index }">${h }</td>
							</c:otherwise>
						</c:choose>
					</c:forEach>
				</tr>
				<tr style="height: 30px" id="r1" class="rate">
					<td></td>
					<c:forEach items="${j.Rate1 }" var="h" varStatus="s">
						<c:choose>
							<c:when test="${s.count<=12 }">
								<c:if test="${s.count==12}">
									<c:set value="Price1" var="show2"></c:set>
								</c:if>
								<td style="font-size: 1.25em; text-align: center;">${show2 }</td>
							</c:when>
							<c:otherwise>
								<c:set value="r1-${s.count }" var="index"></c:set>
								<td
									style="font-size: 1.25em; font-aligh: right; padding-right: 50px;"
									id="${index }">${h }</td>
							</c:otherwise>
						</c:choose>
					</c:forEach>
				</tr>
				<tr style="height: 30px; background: lightyellow;" id="rdiff"
					class="rate">
					<td></td>
					<c:forEach items="${j.RDiff }" var="h" varStatus="s">
						<c:choose>
							<c:when test="${s.count<=12 }">
								<c:if test="${s.count==12}">
									<c:set value="Diff" var="show3"></c:set>
								</c:if>
								<td style="font-size: 1.25em; text-align: center;">${show3 }</td>
							</c:when>
							<c:otherwise>
								<c:set value="rff-${s.count }" var="index"></c:set>
								<td
									style="font-size: 1.25em; font-aligh: right; padding-right: 50px;"
									id="${index }">${h }</td>
							</c:otherwise>
						</c:choose>
					</c:forEach>
				</tr>

				<tr style="height: 30px" id="sum" class="sum">
					<td style="text-align: center; padding: 0px; width: 50px;">合计</td>
					<c:forEach items="${j.titl }" var="h" varStatus="s">
						<c:set value="${s.count+1 }H0" var="index"></c:set>
						<td id="${index }" class="${h }"></td>
					</c:forEach>
				</tr>
				<tr style="height: 35px" class="head">
					<td
						style="text-align: center; font-size: 1.25em; padding: 0px; width: 50px;">编号</td>
					<c:forEach items="${j.titl }" var="h">
						<td style="font-size: 1.25em;">${h }</td>
					</c:forEach>
				</tr>
				<c:forEach items="${j.list }" var="v" varStatus="s">
					<c:choose>
						<c:when test="${s.count % 2 == 0 }">
							<tr class="tbody" style="background: lightyellow;">
								<td
									style='background: lightcyan; font-size: 1em; padding: 0; text-align: center;'>${s.count}</td>
								<c:forEach items="${v }" var="t" varStatus="ss">
									<td
										style='background: lightgrey; font-size: 1em; padding-right: 5px;'
										class="${ss.count+1 }data">${t }</td>
								</c:forEach>
							</tr>
						</c:when>
						<c:otherwise>
							<tr class="tbody" style="background: lightyellow;">
								<td
									style='background: lightcyan; font-size: 1em; padding: 0; text-align: center;'>${s.count}</td>
								<c:forEach items="${v }" var="t" varStatus="ss">
									<td
										style='background: lightyellow; font-size: 1em; padding-right: 5px;'
										class="${ss.count+1 }data">${t }</td>
								</c:forEach>
							</tr>
						</c:otherwise>
					</c:choose>
				</c:forEach>
			</table>
		</div>
	</c:if>
</body>

<script type="text/javascript">

  var oj = JSON.parse($("#optionjson").html());
  var optiondeful = $("#optiondeful").html().split(",");
  var childwindow = [];
  var clcu;

  $(function() {
      $("#batA").show()

    initOption()

    $("select").bind(
            "blur change",
            function() {

              var tv = $(this).val();

              var id = $(this).attr("id")

              id = parseInt(id);

              var va = [];
              var j = oj;

              for (var i = 1; i < id; i++) {
                va.push($("#" + i).val());
              }

              for ( var obj in va) {
                j = j[va[obj]];
              }

              j = j[tv]

              for (var ii = id + 1; ii <= 5; ii++) {

                var oph = "";

                var v = []

                var num = 0;
                for ( var k in j) {

                  v.push(k)
                  num++;
                  var op;
                  if (!isNaN(parseInt(k))) {

                    var kk = k.substring(0, 4) + "-" + k.substring(4, 6) + "-"
                            + k.substring(6, 8);

                    oph += "<option value='"+k+"'>" + kk + "</option>"
                  } else {
                    oph += "<option value='"+k+"'>" + k + "</option>"

                  }
                }
                j = j[v[0]]

                $("#" + ii).html(oph)
              }

            })

    //合计
    calculate()
     
    formatTdsNumber()
  });

  function initOption() {
      
      for(var key in oj){
	  $("#1").append(
	            "<option selected='true' value='"+key+"'>"
	                    + key + "</option>")
      }

    var tv = optiondeful[0]
    
    $("#1").val(tv)
    

    var id = 1

    id = parseInt(id);

    var va = [];
    var j = oj;

    for (var i = 1; i < id; i++) {
      va.push($("#" + i).val());
    }

    for ( var obj in va) {
      j = j[va[obj]];
    }

    j = j[tv]

    for (var ii = id + 1; ii <= 5; ii++) {

      var oph = "";

      var v = []

      var num = 0;
      for ( var k in j) {

        v.push(k)
        num++;
        var op;
        if (!isNaN(parseInt(k))) {

          var kk = k.substring(0, 4) + "-" + k.substring(4, 6) + "-"
                  + k.substring(6, 8);

          oph += "<option value='"+k+"'>" + kk + "</option>"
        } else {
          oph += "<option value='"+k+"'>" + k + "</option>"

        }
      }
      j = j[optiondeful[ii - 1]]

      $("#" + ii).html(oph)
    }

    //确保准确性
    for ( var j in optiondeful) {
      var jj = parseInt(j) + 1;
      $("#" + jj).val(optiondeful[j])
    }

  }

  function queryDeal() {
	if (childwindow['ql'] != undefined)
	    childwindow['ql'].close();
	childwindow['ql'] = window
		.open("/deri-web/eqcmController.do?finddeallist&option=1");
  }

  function calculate() {

    var td=$("#sum").find("td");
  
    var lastIndex=parseInt(td.eq(td.length-1).attr("id"))

    for ( var i=6;i<=lastIndex;i++) {
	calcuIndex(i)
    }

  }
  
  function calcuIndex(num){
      var e = $("." + num + "data");

      var sum = 0.00;

      for (var j = 0; j < e.length; j++) {
        sum += parseFloat(e.eq(j).text())
      }
      
      sum = formatNumber(sum, 2, true);
      
      $("#" + String(num) + "H0").html(sum);
      
      var volXyId=$("#" + String(num) + "H0").attr("class").split("<br>")[0]
      
      $("#"+volXyId).html(sum);
  }

  function formatNumber(num, cent, isThousand) {

    num = num.toString().replace(/\$|\,/g, '');

    // 检查传入数值为数值类型
    if (isNaN(num)) num = "0";

    // 获取符号(正/负数)
    sign = (num == (num = Math.abs(num)));

    num = Math.floor(num * Math.pow(10, cent) + 0.50000000001); // 把指定的小数位先转换成整数.多余的小数位四舍五入
    cents = num % Math.pow(10, cent); // 求出小数位数值
    num = Math.floor(num / Math.pow(10, cent)).toString(); // 求出整数位数值
    cents = cents.toString(); // 把小数位转换成字符串,以便求小数位长度

    // 补足小数位到指定的位数
    while (cents.length < cent)
      cents = "0" + cents;

    if (isThousand) {
      // 对整数部分进行千分位格式化.
      for (var i = 0; i < Math.floor((num.length - (1 + i)) / 3); i++)
        num = num.substring(0, num.length - (4 * i + 3)) + ','
                + num.substring(num.length - (4 * i + 3));
    }

    if (cent > 0)
      return (((sign) ? '' : '-') + num + '.' + cents);
    else
      return (((sign) ? '' : '-') + num);
  }
  
  function formatTdsNumber(){
      
      var tbs=$(".tbody");
      
      for(var i=0;i<tbs.length;i++){
	  
	    var tds=tbs.eq(i).find("td");
	  
	  	for(var j=5;j<tds.length;j++){
	  	  var td=tds.eq(j);
	  	  var old=td.html();
	  	  var newnumber=formatNumber(old, 2, true)
	      td.html(newnumber)
	  	}
      }
  }
  
  
  
  
  
  
  
  
  
</script>